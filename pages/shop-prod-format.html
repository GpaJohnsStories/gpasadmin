<!-- coding: utf-8 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================================================
       SIMPLE SESSION CHECK â€” BLOCKS DIRECT ACCESS WITHOUT TOKEN
  ========================================================== -->
  <script>
    const token = sessionStorage.getItem("githubToken");
    if (!token) window.location.href = "../index.html";
  </script>

  <meta charset="UTF-8">
  <title>GPAS Shop Product Formatter</title>

  <!-- 
    NOTE: Your admin menu is a separate file.
    You will include it manually or via JS injection.
    This <link> is NOT used to import HTML, but we keep it here
    as a reminder of where the menu lives.
    
    admin menu lives at: ../gpas-admin/pages/admin-menu.html
  -->

  <style>
    /* 
      GLOBAL PAGE STYLING 
      --------------------
      Clean, warm, readable. 
      Lexend-like font at 21px as per your admin design standards.
    */
    body {
      font-family: 'Lexend', sans-serif;
      font-size: 21px;
      margin: 0;
      padding: 0;
      background-color: #fdfdf4; /* soft warm background */
    }

    /* 
      TABLE LAYOUT 
      ------------
      Three columns, each ~30% width.
      Goal: no vertical scrolling on a typical desktop.
    */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    td {
      width: 30%;
      vertical-align: top;
      padding: 10px;              /* kept fairly small */
      background-color: #fffbe6;  /* soft yellow input zones */
    }

    /* 
      FORM ELEMENTS 
      --------------
      Clean, readable, consistent.
      Tight margins to reduce vertical height.
    */
    input, select, textarea {
      width: 95%;
      font-size: 21px;
      margin-bottom: 6px;  /* tighter than default */
      padding: 4px;        /* slightly smaller padding */
      border: 3px solid #ccc;
      border-radius: 4px;
    }

    textarea {
      resize: vertical; /* allows expansion if absolutely needed */
    }

    h2, h3 {
      margin-top: 0;
      margin-bottom: 6px;
    }

/* ADMIN ACTION BUTTONS â€” 3D PILL STYLE */
.admin-btn:active {
  transform: translateY(3px);
  box-shadow:
    0 1px 0 rgba(0,0,0,0.35),
    0 3px 6px rgba(0,0,0,0.25);
}

/* PRODUCT CARD PREVIEW WIDTH CONTROL */
#previewBox {
  width: 330px;
  height: 380px;
  padding: 10px;
  border: 4px solid #ccc;
  box-sizing: border-box;   /* ðŸ”’ THIS IS THE KEY */
  overflow: auto;
  background-color: #fdfdf4;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
}

    /* 
      DESCRIPTION COUNTER 
      --------------------
      Small, subtle, below the textarea.
    */
    #descCounter {
      font-size: 16px;
      color: #666;
      margin-top: -4px;
      margin-bottom: 6px;
    }

/* Ensure the card inside doesn't stretch wider */
#previewBox .product-card {
  width: 300px;
  max-width: 300px;
  margin: 0 auto;      /* center it inside the preview box */
}

/* Align title and author in center */
.product-title,
.product-author {
  text-align: center;
}
/* Align product code left, price on right */
.product-code-price-row {
  display: flex;
  justify-content: space-between;
  font-size: 21px;
  margin: 4px 0;
}

/* Make product description regular and NOT bold */
.product-description {
  font-weight: normal;
}

/* Make product tags small font and not bold */
.product-tags {
  font-size: 12pt;
  font-weight: normal;
  color: #444;
  margin-top: 6px;
}

  </style>
</head>

<body>
  <!-- 
    ADMIN MENU PLACEHOLDER 
    -----------------------
    You will manually include the admin menu HTML here.
    This keeps your admin UI consistent across all tools.
  -->
  <div id="admin-header"></div>

  <script>
    // Load the admin menu into the header
    console.log("Loading admin menuâ€¦");
    fetch('admin-menu.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('admin-header').innerHTML = html;
      })
      .catch(err => {
        console.error('Failed to load admin menu:', err);
      });
  </script>

  <!-- PAGE TITLE -->
  <h2 style="text-align:center;">GPAS Shop â€” Format Product Card</h2>

  <!-- 
    MAIN 3-COLUMN TABLE 
    --------------------
    Column 1: Build the Code + Tags + Control Buttons
    Column 2: Product Details (ends after Description)
    Column 3: Format Button + Preview (no raw HTML box)
  -->
  <table>
    <tr>

      <!-- ========================================================= -->
      <!-- COLUMN 1 â€” CONTROL BUTTONS + BUILD THE PRODUCT CODE + TAGS -->
      <!-- ========================================================= -->
      <td>

        <!-- CONTROL BUTTONS -->
<div style="text-align:center; margin-bottom:20px;">

  <button id="saveBtn" class="admin-btn"
    style="
      width:300px;
      padding:12px 0;
      font-family:Lexend;
      font-size:22px;
      font-weight:bold;
      color:white;
      background-color:#228B22;
      border:none;
      border-radius:50px;
      box-shadow:0 4px 0 rgba(0,0,0,0.35), 0 6px 10px rgba(0,0,0,0.25);
      cursor:pointer;
      margin-bottom:14px;
    ">
    SAVE LISTING
  </button>
  <br>

  <button id="saveClearBtn" class="admin-btn"
    style="
      width:300px;
      padding:12px 0;
      font-family:Lexend;
      font-size:22px;
      font-weight:bold;
      color:#228B22;
      background-color:#66FF00;
      border:none;
      border-radius:50px;
      box-shadow:0 4px 0 rgba(0,0,0,0.35), 0 6px 10px rgba(0,0,0,0.25);
      cursor:pointer;
      margin-bottom:14px;
    ">
    SAVE &amp; CLEAR
  </button>
<br>
  <button id="clearBtn" class="admin-btn"
    style="
      width:300px;
      padding:12px 0;
      font-family:Lexend;
      font-size:22px;
      font-weight:bold;
      color:white;
      background-color:#CC0000;
      border:none;
      border-radius:50px;
      box-shadow:0 4px 0 rgba(0,0,0,0.35), 0 6px 10px rgba(0,0,0,0.25);
      cursor:pointer;
      margin-bottom:14px;
    ">
    CLEAR FORM
  </button>
</div>

        <!-- BUILD PRODUCT CODE SECTION -->

        <!-- 3 DROPDOWN BOXES ON SAME LINE -->
        <div style="display:flex; gap:10px;">

<!-- INTEREST -->
<div>
  <label for="interest">Interest:</label><br>
  <select id="interest" style="width:120px; font-weight:bold;"
        onchange="applySelectedOptionStyle('interest')">
  <option value="" selected></option>
    <option value="F"
      style="font-weight:bold; background-color:#5A2D82; color:#FFD700;">
      (F) FAITH
    </option>
    <option value="U"
      style="font-weight:bold; background-color:#B7410E; color:#00FF66;">
      (U) FUN
    </option>
  </select>
</div>

<!-- PRODUCT TYPE -->
<div>
  <label for="ptype">Product Type:</label><br>
  <select id="ptype" style="width:225px; font-weight:bold;"
        onchange="applySelectedOptionStyle('ptype')">
    <option value="" selected></option>
    <!-- Tâ€‘Shirts: rust orange background, bright green text -->
    <option value="T"
      style="font-weight:bold; background-color:#B7410E; color:#00FF66;">
      (T) Tâ€‘SHIRTS
    </option>
    <!-- Books & Bibles: purple background, gold text -->
    <option value="B"
      style="font-weight:bold; background-color:#5A2D82; color:#FFD700;">
      (B) BOOKS & BIBLES
    </option>
    <!-- Other Stuff: medium brown background, white text -->
    <option value="O"
      style="font-weight:bold; background-color:#8B5A2B; color:#FFFFFF;">
      (O) OTHER STUFF
    </option>
  </select>
</div>
</div>

<!-- Site Code, position 3 of Product Code -->
<div>
  <label for="site">Site Family:</label>
  <select id="site" style="width:150px; font-weight:bold;"
        onchange="applySelectedOptionStyle('site')">
  <option value="" selected></option>
    <!-- KIDS: orange background, white text -->
    <option value="4"
      style="font-weight:bold; background:#f97316; color:#ffffff;">
      (4) GpasKids
    </option>
    <!-- FAITH: green background, white text -->
    <option value="1"
      style="font-weight:bold; background:#228b22; color:#ffffff;">
      (1) GpasFaith
    </option>
    <!-- SHOP: medium brown background, white text -->
    <option value="9"
      style="font-weight:bold; background:#a0522d; color:#ffffff;">
      (9) GpasShop
    </option>
  </select>
</div>

<script>
function applySelectedOptionStyle(selectId) {
  const sel = document.getElementById(selectId);
  const opt = sel.options[sel.selectedIndex];

  // Copy the option's background and text color onto the select box
  sel.style.backgroundColor = opt.style.backgroundColor || "#ffffff";
  sel.style.color = opt.style.color || "#000000";
}
</script>

        <!-- TAGS LIVE IN COLUMN 1 (AS YOU REQUESTED) -->
        <label for="tags">Search Tags (comma separated ", "):</label><br>
        <textarea id="tags" rows="4"></textarea>

      </td>

      <!-- ========================================================= -->
      <!-- COLUMN 2 â€” PRODUCT DETAILS (ends after description)       -->
      <!-- ========================================================= -->
      <td>

        <!-- PRODUCT CODE + PRICE ON SAME LINE -->
        <div style="display:flex; gap:40px; align-items:flex-start;">

          <!-- PRODUCT CODE (AUTO + MANUAL SAFE) -->
          <div>
            <label for="pcode">Product Code:</label><br>
            <input
              type="text"
              id="pcode"
              placeholder="IPS-nnn"
              style="width:150px; font-weight:bold;"
              oninput="validateCode(this)">
          </div>

          <!-- PRICE -->
          <div>
            <label for="cost">Price: (No "$")</label><br>
            <input
              type="text"
              id="cost"
              style="width:80px; font-weight:bold;"
              oninput="validatePrice(this)">
          </div>

        </div>

        <!-- PRODUCT LINK URL (public product page) -->
        <input
          id="purl"
          type="text"
          placeholder="Product Link URL"
          style="width:95%; font-size:21px; font-weight:bold; margin-bottom:6px;">

        <!-- IMAGE URL (path to product image) -->
        <input
          id="imgurl"
          type="text"
          placeholder="Product Image URL"
          style="width:95%; font-size:21px; font-weight:bold; margin-bottom:6px;">

        <!-- PRODUCT TITLE -->
        <input
          id="title"
          type="text"
          placeholder="Product Title"
          style="width:95%; font-size:21px; font-weight:bold; margin-bottom:6px;">

        <!-- BOOK AUTHOR or BIBLE VERSION -->
        <input
          id="author"
          type="text"
          placeholder="Author or Version"
          style="width:95%; font-size:21px; font-weight:bold; margin-bottom:6px;">

        <!-- DESCRIPTION -->
        <label for="desc">Description (600 chars):</label><br>
        <textarea id="desc" maxlength="600" rows="5"></textarea>
        <div style="display:flex; justify-content:space-between; font-size:14px; margin-top:4px;">
          <span id="descCounter">0 / 600</span>
          <span id="shortWordPct">0% 5-letter words</span>
        </div>

      </td>

      <!-- ========================================================= -->
      <!-- COLUMN 3 â€” PREVIEW BUTTON + PREVIEW ONLY                   -->
      <!-- ========================================================= -->
      <td>

        <!-- PREVIEW BUTTON -->
<button id="formatBtn" class="admin-btn"
  style="
    width:330px;
    padding:12px 0;
    font-family:Lexend;
    font-size:22px;
    font-weight:bold;
    color:white;
    background-color:#228B22;
    border:none;
    border-radius:50px;
    box-shadow:0 4px 0 rgba(0,0,0,0.35), 0 6px 10px rgba(0,0,0,0.25);
    cursor:pointer;
    margin-bottom:14px;
  ">
  PREVIEW LISTING
</button>


        
        <!-- PREVIEW BOX (SCROLLABLE) -->
        <div id="previewBox">
          <!-- formatted preview will appear here -->
        </div>

      </td>

    </tr>
  </table>

  <!-- ============================================================= -->
  <!-- JAVASCRIPT SECTION                                            -->
  <!-- ============================================================= -->
  <script>
  /* ===============================================================
     DESCRIPTION CHARACTER + SHORT WORD COUNTER
     Keeps the "0 / 600" display in sync with textarea length.
  ================================================================= */
(function setupDescriptionCounter() {
  const desc = document.getElementById('desc');
  const descCounter = document.getElementById('descCounter');
  const shortWordPct = document.getElementById('shortWordPct');

  if (!desc || !descCounter || !shortWordPct) return;

  desc.addEventListener('input', () => {
    const text = desc.value.trim();
    descCounter.textContent = text.length + ' / 600';

    if (!text) {
      shortWordPct.textContent = '0% short words';
      return;
    }

    const words = text.split(/\s+/);
    const shortWords = words.filter(w =>
      w.replace(/[^a-zA-Z]/g, '').length <= 5
    );

    const pct = Math.round((shortWords.length / words.length) * 100);
    shortWordPct.textContent = pct + '% short words';
  });
})();

/* ===============================================================
   PRODUCT CODE BUILDER
   Pattern: [INTEREST][TYPE][SITE]-[NNN].html
   - INTEREST = F, U, A
   - TYPE     = T, B, O, E
   - SITE     = 1 (Faith), 4 (Kids), 9 (Shop)
   - Auto-increments suffix by scanning /prod on GitHub
================================================================= */
async function buildProductCode() {
  const interest = document.getElementById("interest").value.toUpperCase();
  const ptype    = document.getElementById("ptype").value.toUpperCase();
  const site     = document.getElementById("site").value;  // NEW

  // Need all three dropdowns selected before we attempt a code
  if (!interest || !ptype || !site) return;

  // Build prefix with new Site Code in position 3
  const prefix = interest + ptype + site;

  // GitHub API: list files in prod/ directory
  const apiUrl = "https://api.github.com/repos/GpaJohnsStories/GpasShop/contents/prod";

  let nextSuffix = "001";

  try {
    const response = await fetch(apiUrl);
    if (response.ok) {
      const files = await response.json();

      // Match: PREFIX-NNN.html  (case insensitive)
      const regex = new RegExp("^" + prefix + "-(\\d{3})\\.html$", "i");
      let max = 0;

      for (const item of files) {
        if (!item || !item.name) continue;

        const match = item.name.match(regex);
        if (match && match[1]) {
          const num = parseInt(match[1], 10);
          if (num > max) max = num;
        }
      }

      nextSuffix = String(max + 1).padStart(3, "0");
    }
  } catch (err) {
    console.error("Error fetching suffix from GitHub:", err);
  }

  const finalCode = prefix + "-" + nextSuffix;
  document.getElementById("pcode").value = finalCode;
}



  // Rebuild code whenever interest or type or site changes
  document.getElementById("interest").addEventListener("change", buildProductCode);
  document.getElementById("ptype").addEventListener("change", buildProductCode);
  document.getElementById("site").addEventListener("change", buildProductCode);



  /* ===============================================================
     PRODUCT CODE VALIDATION (manual typing safety)
     - Forces pattern like IP?-NNN.
     - Strips invalid characters, uppercases letters.
  ================================================================= */
  function validateCode(input) {
    let v = input.value.toUpperCase();
    // Only letters, digits, and dash allowed
    v = v.replace(/[^A-Z0-9\-]/g, "");

    const parts = v.split("-");
    let left = (parts[0] || "").replace(/[^A-Z0-9]/g, "").substring(0, 3);
    let right = (parts[1] || "").replace(/[^0-9]/g, "").substring(0, 3);

    if (!left) {
      input.value = "";
      return;
    }

    let result = left;
    if (right || v.includes("-")) result += "-";
    if (right) result += right;

    input.value = result;
  }


  /* ===============================================================
     PRICE VALIDATION (INPUT FIELD)
     - No "$" or commas in the box.
     - Only digits and at most one decimal.
  ================================================================= */
  function validatePrice(input) {
    // Remove $ and commas
    let v = input.value.replace(/[$,]/g, "");

    // Allow only digits and decimal point
    v = v.replace(/[^0-9.]/g, "");

    // If multiple decimals, keep first two segments only
    const parts = v.split(".");
    if (parts.length > 2) {
      v = parts[0] + "." + parts[1];
    }

    input.value = v;
  }


  /* ===============================================================
     PRICE FORMATTER (FOR DISPLAY)
     - Converts raw "12" or "12.5" to "$ 12.50".
     - If input is invalid, falls back to "$ 0.00".
  ================================================================= */
  function formatPrice(raw) {
    if (!raw) return "$ 0.00";
    let n = parseFloat(String(raw).replace(/[^0-9.]/g, ""));
    if (isNaN(n)) n = 0;
    return "$ " + n.toFixed(2);
  }


  /* ===============================================================
     TAG NORMALIZER
     - Takes textarea value and converts to "tag1, tag2, tag3".
     - Strips extra whitespace and empty entries.
  ================================================================= */
  function normalizeTags(rawTags) {
    if (!rawTags) return "";

    // Split on commas, trim each piece
    const parts = rawTags.split(",").map(t => t.trim()).filter(t => t.length > 0);

    return parts.join(", ");
  }

// Post Store Name    
function detectStoreName(url) {
  if (!url) return "";

  const u = url.toLowerCase();

  if (u.includes("amazon")) return "Amazon";
  if (u.includes("zazzle")) return "Zazzle";

  // Futureâ€‘proofing: if you ever add a bookstore
  if (u.includes("book")) return "Book Store";

  return "";
}


  /* ===============================================================
     FORMAT LISTING
     - Collects all fields.
     - Builds the product card HTML.
     - Updates preview and window.finalProductHTML (for saving).
  ================================================================= */
  function formatListing() {

  // ---------------------------------------------------------------
  // REQUIRED FIELD GUARDS (HARD STOP)
  // ---------------------------------------------------------------
  const title  = document.getElementById("title").value.trim();
  const imgurl = document.getElementById("imgurl").value.trim();
  const purl   = document.getElementById("purl").value.trim();

  if (!title) {
    alert("ERROR: Product title is required.");
    return;
  }

  if (!imgurl) {
    alert("ERROR: Product image URL is required.");
    return;
  }

  if (!purl) {
    alert("ERROR: Product URL is required.");
    return;
  }
  const storeName = detectStoreName(purl);
  
  // ---------------------------------------------------------------
  // 1) Grab remaining OPTIONAL field values
  // ---------------------------------------------------------------
  const code   = (document.getElementById("pcode").value || "").trim();
  const author = (document.getElementById("author").value || "").trim();
  const cost   = (document.getElementById("cost").value || "").trim();
  const desc   = (document.getElementById("desc").value || "").trim();
  const tagsRaw   = (document.getElementById("tags").value || "").trim();

  // title, imgurl, purl are already available and valid
  // ... continue building HTML ...
    
// 2) Build cost HTML (hide if blank or zero)
let costHTML = "";
if (cost && !isNaN(cost) && Number(cost) > 0) {
  const formatted = Number(cost).toFixed(2);
  costHTML = `<div class="price">$ ${formatted}</div>`;
}

    
    // 3) Basic safety checks
    if (!code) {
      alert("Product Code is required before formatting.");
      return;
    }
    if (!title) {
      alert("Product Title is required.");
      return;
    }

    // 4) Normalize price + tags
    const tagsDisplay  = normalizeTags(tagsRaw);

    // 5) Build card HTML (this is what the shop page will use)
    //    Adjust structure and classes to match your live product wall.
    // other border colors: #999 Medium Gray, #aaa Light-Medium Gray,
    // #bbb between #aaa and #ccc, #888 dark-medium gray

    /* ===============================================================
   CREATE BUTTON FOR ONLINE STORE
   - Displays a pillâ€‘shaped 3D button linking to the product page
   - Automatically includes detected store name (Amazon, Zazzle, etc.)
================================================================= */

const cardHTML =
  "<article style='width:300px; border:4px solid #999; padding:10px; box-sizing:border-box;'>" +
    "<div style='text-align:center;'>" +
      (imgurl
        ? "<a href='" + encodeURI(purl || "#") + "' target='_blank' rel='noopener noreferrer'>" +
            "<img src='" + encodeURI(imgurl) + "' alt='" + escapeHtml(title) + "' style='width:100%; height:auto; border:0;'>" +
          "</a>"
        : "") +
    "</div>" +
    "<h3 style='font-family:Lexend; font-size:24px; font-weight:bold; text-align:center; margin:10px 0 5px 0;'>" +
      escapeHtml(title) +
    "</h3>" +
    (author
      ? "<div style='font-family:Lexend; font-size:21px; font-weight:bold; text-align:center; margin-bottom:8px;'>" +
          escapeHtml(author) +
        "</div>"
      : "") +
"<div style='font-family:Lexend; font-size:21px; margin:10px 0;" +
  (cost && !isNaN(cost) && Number(cost) > 0
    ? " display:flex; justify-content:space-between;'>"
    : " text-align:center;'>") +
  "<span>" + escapeHtml(code) + "</span>" +
  (cost && !isNaN(cost) && Number(cost) > 0
    ? "<span>$ " + Number(cost).toFixed(2) + "</span>"
    : "") +
"</div>" +
(desc
  ? "<p style='font-family:Lexend; font-size:21px; font-weight:400; line-height:26px; margin:10px 0;'>" +
      escapeHtml(desc) +
    "</p>"
  : "") +
(purl
  ? "<div style='margin:14px 0; text-align:center;'>" +
      "<a href='" + encodeURI(purl) + "' target='_blank' rel='noopener noreferrer' " +
         "style='display:inline-block; " +
                "padding:10px 22px; " +
                "font-family:Lexend; " +
                "font-size:18px; " +
                "font-weight:bold; " +
                "color:#fff; " +
                "background:#2e7d32; " +
                "border:4px solid #1b5e20; " +
                "border-radius:999px; " +
                "box-shadow:0 3px 0 #666; " +
                "text-decoration:none;'>" +
        "View Details" +
        (storeName ? " at " + storeName + ".com" : "") +
      "</a>" +
    "</div>"
  : "") +

    (tagsDisplay
      ? "<div style='font-family:Lexend; font-size:18px; font-weight:normal; color:#666; margin-top:10px;'>Tags: " +
          escapeHtml(tagsDisplay) +
        "</div>"
      : "") +
  "</article>";

    // 6) Store in global for saving
    window.finalProductHTML = cardHTML;

    // 7) Update preview
    const preview = document.getElementById("previewBox");
    if (preview) {
      preview.innerHTML =
  "<div style='font-weight:400;'>" +
    cardHTML +
  "</div>";
    }
  }

  /* ===============================================================
     ESCAPE HTML HELPER
     - Prevents broken HTML when user types <, >, & in fields.
  ================================================================= */
  function escapeHtml(str) {
    if (!str) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }


  /* ===============================================================
     REQUIRE TOKEN HELPER
     - Ensures we have the GitHub token before API calls.
  ================================================================= */
  function requireToken() {
    const token = sessionStorage.getItem("githubToken");
    if (!token) {
      alert("Missing GitHub token. Please log in again.");
      return null;
    }
    return token;
  }


  /* ===============================================================
     LOAD PRODUCT
     - Prompts for a product code.
     - Fetches prod/[code].html from GitHub.
     - Parses the HTML to re-fill the form as best we can.
     - NOTE: Parsing is approximate, but enough for admin edits.
  ================================================================= */
  async function loadProduct() {
    const code = prompt("Enter the product code to load (e.g., FT1-001):");
    if (!code) return;

    const token = requireToken();
    if (!token) return;

    const filename = `${code}.html`;
    const filePath = `prod/${filename}`;
    const url = `https://api.github.com/repos/GpaJohnsStories/GpasShop/contents/${filePath}`;

    try {
      const resp = await fetch(url, {
        headers: { "Authorization": `token ${token}` }
      });

      if (!resp.ok) {
        alert("Could not load that product. Check the code and try again.");
        return;
      }

      const data = await resp.json();
      const contentDecoded = decodeURIComponent(escape(window.atob(data.content)));

      // Very simple parsing: create a temporary DOM
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = contentDecoded;

      const card = tempDiv.querySelector(".product-card");
      if (!card) {
        alert("Loaded file does not contain a recognizable product card.");
        return;
      }

      // Extract fields from card
      const titleEl   = card.querySelector(".product-title");
      const authorEl  = card.querySelector(".product-author");
      const codeEl    = card.querySelector(".product-code");
      const priceEl   = card.querySelector(".product-price");
      const descEl    = card.querySelector(".product-description");
      const tagsEl    = card.querySelector(".product-tags");
      const imgEl     = card.querySelector("img.product-image");
      const linkEl    = card.querySelector(".product-link a");

      document.getElementById("pcode").value  = codeEl ? codeEl.textContent.trim() : code;
      document.getElementById("title").value  = titleEl ? titleEl.textContent.trim() : "";
      document.getElementById("author").value = authorEl ? authorEl.textContent.trim() : "";

      // Strip "$ " from price if present
      if (priceEl) {
        let rawPrice = priceEl.textContent.replace("$", "").trim();
        document.getElementById("cost").value = rawPrice;
      } else {
        document.getElementById("cost").value = "";
      }

      document.getElementById("desc").value = descEl ? descEl.textContent.trim() : "";
      // Trigger desc counter update
      const descCounter = document.getElementById("descCounter");
      if (descCounter) {
        descCounter.textContent = document.getElementById("desc").value.length + " / 600";
      }

      if (tagsEl) {
        const txt = tagsEl.textContent.replace(/^Tags:\s*/i, "").trim();
        document.getElementById("tags").value = txt;
      } else {
        document.getElementById("tags").value = "";
      }

      document.getElementById("imgurl").value = imgEl ? imgEl.getAttribute("src") || "" : "";
      document.getElementById("purl").value   = linkEl ? linkEl.getAttribute("href") || "" : "";

      // Rebuild preview from loaded card
      window.finalProductHTML = card.outerHTML;
      const preview = document.getElementById("previewBox");
      if (preview) {
        preview.innerHTML = window.finalProductHTML;
      }

      alert("Product loaded into the form.");
    } catch (err) {
      console.error("Error loading product:", err);
      alert("Error loading product. See console for details.");
    }
  }


  /* ===============================================================
     DELETE PRODUCT FILE
     - Prompts for confirmation.
     - Sends DELETE via GitHub API using file SHA.
  ================================================================= */
  async function deleteProductFile() {
    const codeField = document.getElementById("pcode");
    const code = codeField ? codeField.value.trim() : "";

    if (!code) {
      alert("Enter or load a product code before deleting.");
      return;
    }

    if (!confirm(`Really delete product file for code: ${code}?`)) {
      return;
    }

    const token = requireToken();
    if (!token) return;

    const filename = `${code}.html`;
    const filePath = `prod/${filename}`;
    const url = `https://api.github.com/repos/GpaJohnsStories/GpasShop/contents/${filePath}`;

    try {
      // First get SHA
      const checkResp = await fetch(url, {
        headers: { "Authorization": `token ${token}` }
      });

      if (!checkResp.ok) {
        alert("Could not find that product file on GitHub.");
        return;
      }

      const data = await checkResp.json();
      const sha = data.sha;

      // Now delete
      const deleteResp = await fetch(url, {
        method: "DELETE",
        headers: {
          "Authorization": `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Delete product ${filename}`,
          sha: sha
        })
      });

      if (deleteResp.ok) {
        alert(`Deleted product file:\nprod/${filename}`);
        clearFormFields();
      } else {
        const errData = await deleteResp.json();
        alert("GitHub delete failed:\n" + JSON.stringify(errData, null, 2));
      }
    } catch (err) {
      console.error("Error deleting product:", err);
      alert("Error deleting product. See console for details.");
    }
  }


  /* ===============================================================
     SAVE PRODUCT FILE
     - Uses window.finalProductHTML (from formatListing()).
     - Wraps it in a full HTML file with timestamp + price comment.
     - PUT to prod/[code].html via GitHub API.
  ================================================================= */
  async function saveProductFile() {
    const code = (document.getElementById("pcode").value || "").trim();
    if (!code) {
      alert("Product Code is required before saving.");
      return;
    }

    if (!window.finalProductHTML) {
      if (!confirm("No formatted listing yet. Save anyway?")) {
        return;
      }
    }

    const now = new Date().toISOString();
    const timestampComment = "<!-- Saved: " + now + " -->\n";

const rawPrice = (document.getElementById("cost").value || "").trim();

      let priceComment = "";
      let priceDisplay = "";

// Only treat price as real if > 0
if (rawPrice && !isNaN(rawPrice) && Number(rawPrice) > 0) {
  priceDisplay = formatPrice(rawPrice);
  priceComment = "<!-- Price: " + priceDisplay + " -->\n";
}

    const fileContent =
      "<!DOCTYPE html>\n<html>\n<head>\n" +
      "  <meta charset='UTF-8'>\n" +
      "  <title>" + code + "</title>\n" +
      "</head>\n<body>\n" +
      timestampComment +
      priceComment +
      (window.finalProductHTML || "") +
      "\n</body>\n</html>";

    const token = requireToken();
    if (!token) return;

    const filename = `${code}.html`;
    const filePath = `prod/${filename}`;
    const contentBase64 = btoa(unescape(encodeURIComponent(fileContent)));

    let sha = null;
    const checkUrl = `https://api.github.com/repos/GpaJohnsStories/GpasShop/contents/${filePath}`;

    try {
      const checkResp = await fetch(checkUrl, {
        headers: { "Authorization": `token ${token}` }
      });
      if (checkResp.ok) {
        const data = await checkResp.json();
        sha = data.sha;
      }
    } catch (err) {
      console.error("Error checking file:", err);
    }

    const uploadResp = await fetch(checkUrl, {
      method: "PUT",
      headers: {
        "Authorization": `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: `Save product ${filename}`,
        content: contentBase64,
        sha: sha || undefined
      })
    });

    if (uploadResp.ok) {
      alert(`Saved to GitHub:\nprod/${filename}`);
    } else {
      const errData = await uploadResp.json();
      alert("GitHub save failed:\n" + JSON.stringify(errData, null, 2));
    }
  }


  /* ===============================================================
     CLEAR FORM FIELDS
     - Resets all inputs.
     - Clears preview and finalProductHTML.
  ================================================================= */
  function clearFormFields() {
    const codeEl   = document.getElementById('pcode');
    const titleEl  = document.getElementById('title');
    const costEl   = document.getElementById('cost');
    const descEl   = document.getElementById('desc');
    const interest = document.getElementById('interest');
    const ptype    = document.getElementById('ptype');
    const tagsEl   = document.getElementById('tags');
    const purlEl   = document.getElementById('purl');
    const imgurlEl = document.getElementById('imgurl');

    if (codeEl)   codeEl.value = '';
    if (titleEl)  titleEl.value = '';
    if (costEl)   costEl.value = '';
    if (descEl)   descEl.value = '';
    if (tagsEl)   tagsEl.value = '';
    if (purlEl)   purlEl.value = '';
    if (imgurlEl) imgurlEl.value = '';

    const descCounter = document.getElementById('descCounter');
    if (descCounter) descCounter.textContent = '0 / 600';

    if (interest) interest.value = '';
    if (ptype)    ptype.value = '';

    const preview = document.getElementById("previewBox");
    if (preview) preview.innerHTML = '';

    window.finalProductHTML = '';
  }

/* ===============================================================
   BUTTON HANDLERS â€” CLEAN, SINGLE-TRIGGER SETUP
================================================================ */

/* SAVE LISTING */
document.getElementById("saveBtn").addEventListener("click", () => {
  saveProductFile();
});

/* SAVE & CLEAR */
document.getElementById("saveClearBtn").addEventListener("click", () => {
  saveProductFile();
  if (confirm("Clear all fields?")) clearFormFields();
});

/* CLEAR FORM */
document.getElementById("clearBtn").addEventListener("click", () => {
  if (confirm("Clear all fields?")) clearFormFields();
});

/* PREVIEW LISTING */
document.getElementById("formatBtn").addEventListener("click", () => {
  formatListing();
});

  </script>

</body>
</html>

