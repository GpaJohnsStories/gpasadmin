<!-- coding: utf-8 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    const token = sessionStorage.getItem("githubToken");
    if (!token) window.location.href = "../index.html";
  </script>

  <meta charset="UTF-8">
  <title>GPAS Shop Product Formatter</title>

  <!-- 
    NOTE: Your admin menu is a separate file.
    You will include it manually or via JS injection.
    This <link> is NOT used to import HTML, but we keep it here
    as a reminder of where the menu lives.
  -->
  <!-- admin menu lives at: ../gpas-admin/pages/admin-menu.html -->

  <style>
    /* 
      GLOBAL PAGE STYLING 
      --------------------
      Clean, warm, readable. 
      Lexend font at 21px as per your admin design standards.
    */
    body {
      font-family: 'Lexend', sans-serif;
      font-size: 21px;
      margin: 0;
      padding: 0;
      background-color: #fdfdf4; /* soft warm background */
    }

    /* 
      TABLE LAYOUT 
      ------------
      Three columns, each 30% width.
      No scrolling for inputs — only preview scrolls.
    */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    td {
      width: 30%;
      vertical-align: top;
      padding: 10px;
      background-color: #fffbe6; /* soft yellow input zones */
    }

    /* 
      FORM ELEMENTS 
      --------------
      Clean, readable, consistent.
    */
    input, select, textarea {
      width: 95%;
      font-size: 21px;
      margin-bottom: 10px;
      padding: 6px;
      border: 3px solid #ccc;
      border-radius: 4px;
    }

    textarea {
      resize: vertical; /* allows expansion for tags */
    }

    /* 
      BUTTONS 
      -------
      Warm, friendly, hover glow.
    */
    button {
      font-size: 21px;
      padding: 8px 16px;
      margin: 8px 0;
      border: none;
      border-radius: 6px;
      background-color: #ffcc66;
      cursor: pointer;
    }

    button:hover {
      background-color: #ffdb99;
    }

    /* 
      PREVIEW BOX 
      -----------
      Only area allowed to scroll.
    */
    #previewBox {
      width: 100%;
      height: 300px;
      overflow: auto;
      border: 4px solid #ccc;
      padding: 10px;
      background-color: #fdfdf4;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    /* 
      DESCRIPTION COUNTER 
      --------------------
      Small, subtle, below the textarea.
    */
    #descCounter {
      font-size: 16px;
      color: #666;
      margin-top: -8px;
      margin-bottom: 10px;
    }

    /* 
      CENTER BUTTONS 
      --------------
      For Load / Clear at bottom.
    */
    .center-buttons {
      text-align: center;
      padding: 20px;
    }

    h2, h3 {
      margin-top: 0;
    }

    /* 
      INLINE BUTTON ROW (Save + Delete)
    */
    .inline-buttons {
      display: flex;
      gap: 10px;
    }
  </style>
</head>

<body>
  <!-- 
    ADMIN MENU PLACEHOLDER 
    -----------------------
    You will manually include the admin menu HTML here.
    This keeps your admin UI consistent across all tools.
  -->
  <div id="admin-header"></div>

  <script>
    // Load the admin menu into the header
    console.log("Loading admin menu…");
    fetch('admin-menu.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('admin-header').innerHTML = html;
      })
      .catch(err => {
        console.error('Failed to load admin menu:', err);
      });
  </script>

  <!-- PAGE TITLE -->
  <h2 style="text-align:center;">GPAS Shop Product Formatter -- 01/10 - 18</h2>

  <!-- 
    MAIN 3-COLUMN TABLE 
    --------------------
    Column 1: Build the Code + Tags (moved here)
    Column 2: Product Details (now ends after Description)
    Column 3: Format + Preview + Save/Delete (same line)
  -->
  <table>
    <tr>

 <!-- ========================================================= -->
<!-- COLUMN 1 — CONTROL BUTTONS + BUILD THE PRODUCT CODE + TAGS -->
<!-- ========================================================= -->
<td>

  <!-- CONTROL BUTTONS -->
<div class="inline-buttons" style="margin-top:5px;">
	<button id="saveBtn" style="background-color:#228B22; color:white;width:200px;">
	  SAVE LISTING</button>
	<button id="loadBtn" style="background-color:#228B22; color:white; width:200px;">
		LOAD PRODUCT</button>
	</div>

<div class="inline-buttons" style="margin-top:5px;">
	<button id="saveClearBtn" style="background-color:#cc0000; color:white;width:200px;">
		<strong>SAVE & CLEAR</strong></button> 
    <button id="clearBtn" style="background-color:#cc0000; color:white; width:200px;">
		<strong>CLEAR FORM</strong></button>
	</div>

<div class="inline-buttons" style="margin-top:5px;">
	<button id="deleteBtn" style="background-color:#cc0000; color:white; width:410px;">
  		<strong>DELETE LISTING</strong></button>
	</div>


  <h3>Build Product Code</h3>
<!-- 2 Dropdown Boxes on Same Line -->
<div style="display:flex; gap:20px;">

  <!-- INTEREST -->
  <div>
    <label>Interest:</label><br>
    <select id="interest" style="width:150px;">
      <option value="" selected></option>
      <option value="F">FAITH</option>
      <option value="U">FUN</option>
      <option value="A">ALL</option>
    </select>
  </div>

  <!-- PRODUCT TYPE -->
  <div>
    <label>Product Type:</label><br>
    <select id="ptype" style="width:225px;">
      <option value="" selected></option>
      <option value="T">T‑SHIRTS</option>
      <option value="B">BOOKS & BIBLES</option>
      <option value="O">OTHER STUFF</option>
      <option value="E">EVERYTHING</option>
    </select>
  </div>

</div>


  <!-- TAGS MOVED HERE -->
  <label>Search Tags (comma separated ", "):</label><br>
  <textarea id="tags" rows="4"></textarea>

</td>

      <!-- ========================================================= -->
      <!-- COLUMN 2 — PRODUCT DETAILS (ends after description)       -->
      <!-- ========================================================= -->
      <td>
        <h3>Product Details</h3>

        <!-- PRODUCT CODE -->
    <div style="display:flex; gap:40px; align-items:flex-start;">

       <div>
            <label for="pcode">Product Code:</label><br>
            <input type="text" id="pcode" placeholder="IP?-nnn"
                 style="width:120px; font-weight:bold;"
                 oninput="validateCode(this)">
       </div>

        <!-- PRICE-->
       <div>
            <label for="cost">Price: (No "$" needed)</label><br>
            <input type="text" id="cost"
              style="width:80px; font-weight:bold;"
              oninput="validatePrice(this)">

        </div>

</div>


        <!-- PRODUCT LINK URL -->
        <input id="purl" type="text" placeholder="Product Link URL" style="width:95%;  font-size:21px; font-weight:bold; margin-bottom:10px;">
		
        <!-- SAVE IMAGE AS URL -->
        <input id="imgurl" type="text" placeholder="Save Image As URL" style="width:95%; font-size:21px; font-weight:bold; margin-bottom:10px;">

        <!-- PRODUCT TITLE -->
         <input id="title" type="text" placeholder="Product Title" style="width:95%; font-size:21px; font-weight:bold; margin-bottom:10px;">

         <!-- BOOK AUTHOR or BIBLE VERSION-->
        <input id="author" type="text" placeholder="Author or Version" style="width:95%; font-size:21px; font-weight:bold; margin-bottom:10px;">

        <!-- DESCRIPTION -->
        <label>Description (600 chars):</label><br>
        <textarea id="desc" maxlength="600" rows="5"></textarea>
        <div id="descCounter">0 / 600</div>

        <!-- 
          NOTE:
          Tags were moved to Column 1.
          This frees space so Save/Delete buttons in Column 3
          can align visually with the end of Column 2.
        -->
      </td>

      <!-- ========================================================= -->
      <!-- COLUMN 3 — FORMAT + PREVIEW + SAVE/DELETE (same line)     -->
      <!-- ========================================================= -->
      <td>
        <h3>Format & Preview</h3>

        <!-- FORMAT BUTTON -->
        <button id="formatBtn"><strong>FORMAT LISTING</strong></button><br>

        <!-- PREVIEW BOX -->
        <div id="previewBox">
          <!-- formatted preview will appear here -->
        </div><br>


      </td>

    </tr>
  </table>

  <!-- ============================================================= -->
  <!-- JAVASCRIPT SECTION                                            -->
  <!-- ============================================================= -->
<script>
/* ===============================================================
   DESCRIPTION CHARACTER COUNTER
================================================================ */
const desc = document.getElementById('desc');
const descCounter = document.getElementById('descCounter');

desc.addEventListener('input', () => {
  descCounter.textContent = desc.value.length + ' / 600';
});


/* ===============================================================
   BUILD PRODUCT CODE (PREFIX + AUTO-INCREMENT SUFFIX)
================================================================ */
async function buildProductCode() {
  const interest = document.getElementById("interest").value.toUpperCase();
  const ptype    = document.getElementById("ptype").value.toUpperCase();

  if (!interest || !ptype) return;

  const prefix = interest + ptype + "1";

  const apiUrl = "https://api.github.com/repos/GpaJohnsStories/GpasShop/contents/prod";

  let nextSuffix = "001";

  try {
    const response = await fetch(apiUrl);
    if (response.ok) {
      const files = await response.json();

      const regex = new RegExp("^" + prefix + "-(\\d{3})\\.html$", "i");

      let max = 0;

      for (const item of files) {
        if (!item || !item.name) continue;

        const match = item.name.match(regex);
        if (match && match[1]) {
          const num = parseInt(match[1], 10);
          if (num > max) max = num;
        }
      }

      nextSuffix = String(max + 1).padStart(3, "0");
    }
  } catch (err) {
    console.error("Error fetching suffix:", err);
  }

  const finalCode = prefix + "-" + nextSuffix;
  document.getElementById("pcode").value = finalCode;
}

document.getElementById("interest").addEventListener("change", buildProductCode);
document.getElementById("ptype").addEventListener("change", buildProductCode);


/* ===============================================================
   PRODUCT CODE VALIDATION (manual typing safety)
================================================================ */
function validateCode(input) {
  let v = input.value.toUpperCase();
  v = v.replace(/[^A-Z0-9\-]/g, "");

  const parts = v.split("-");
  let left = (parts[0] || "").replace(/[^A-Z0-9]/g, "").substring(0, 3);
  let right = (parts[1] || "").replace(/[^0-9]/g, "").substring(0, 3);

  if (!left) {
    input.value = "";
    return;
  }

  let result = left;
  if (right || v.includes("-")) result += "-";
  if (right) result += right;

  input.value = result;
}


/* ===============================================================
   LOAD PRODUCT FROM GITHUB
================================================================ */
async function loadProduct() {
  const code = document.getElementById("pcode").value.trim();

  if (!code) {
    alert("Enter a product code like FT1-001");
    return;
  }

  const url = `https://raw.githubusercontent.com/GpaJohnsStories/GpasShop/main/prod/${code}.html`;

  try {
    const response = await fetch(url);

    if (!response.ok) {
      alert(`Product ${code} not found in /prod/`);
      return;
    }

    const html = await response.text();
    document.getElementById("prodHtml").value = html;

  } catch (err) {
    alert("Error loading product:\n" + err);
  }
}


/* ===============================================================
   GITHUB TOKEN HANDLING
================================================================ */
function requireToken() {
  let token = window.top.sessionStorage.getItem("githubToken");
  if (token) return token;

  alert("Please give me another fun idea!");
  return null;
}

/* ===============================================================
   FORMAT LISTING — BUILD finalProductHTML + SHOW PREVIEW
================================================================ */
function formatListing() {

  // 1. Ensure product code exists
  let code = document.getElementById("pcode").value.trim();
  if (!code) {
    // Trigger auto-builder if dropdowns are selected
    buildProductCode();
    code = document.getElementById("pcode").value.trim();
  }

  if (!code) {
    alert("Please select Interest and Product Type so I can build the product code.");
    return;
  }

  // 2. Collect all fields
  const title = document.getElementById("title").value.trim();
  const author = document.getElementById("author").value.trim();
  const desc = document.getElementById("desc").value.trim();
  const imgurl = document.getElementById("imgurl").value.trim();
  const purl = document.getElementById("purl").value.trim();

  // 3. Build formatted HTML (your product card)
  const html =
    `<div class="product-card">
       <img src="${imgurl}" alt="${title}" class="product-image">
       <h2 class="product-title">${title}</h2>
       <h3 class="product-author">${author}</h3>
       <p class="product-desc">${desc}</p>
       <a href="${purl}" class="product-link">View Product</a>
       <div class="product-code">${code}</div>
     </div>`;

  // 4. Save globally for SAVE button
  window.finalProductHTML = html;

  // 5. Show preview
  document.getElementById("previewBox").innerHTML = html;
}


/* ===============================================================
   SAVE PRODUCT FILE TO GITHUB
================================================================ */
async function saveProductFile() {

  console.log("saveProductFile fired");

  if (!window.finalProductHTML) {
    alert("Please click FORMAT before saving.");
    return;
  }

  const code = document.getElementById('pcode').value.trim();
  if (!/^[A-Z0-9]{3}-\d{3}$/.test(code)) {
    alert("Product code must look like FT1-001.");
    return;
  }

  const cost = document.getElementById('cost').value.trim();
  const now = new Date().toISOString();

  const timestampComment = "<!-- date_added: " + now + " -->\n\n";
  const priceComment     = "<!-- price: " + cost + " -->\n";

  const fileContent =
    "<!DOCTYPE html>\n<html>\n<head>\n" +
    "  <meta charset='UTF-8'>\n" +
    "  <title>" + code + "</title>\n" +
    "</head>\n<body>\n" +
    timestampComment +
    priceComment +
    window.finalProductHTML +
    "\n</body>\n</html>";

  const token = requireToken();
  if (!token) return;

  const filename = `${code}.html`;
  const filePath = `prod/${filename}`;
  const contentBase64 = btoa(unescape(encodeURIComponent(fileContent)));

  let sha = null;
  const checkUrl = `https://api.github.com/repos/GpaJohnsStories/GpasShop/contents/${filePath}`;

  try {
    const checkResp = await fetch(checkUrl, {
      headers: { "Authorization": `token ${token}` }
    });
    if (checkResp.ok) {
      const data = await checkResp.json();
      sha = data.sha;
    }
  } catch (err) {
    console.error("Error checking file:", err);
  }

  const uploadResp = await fetch(checkUrl, {
    method: "PUT",
    headers: {
      "Authorization": `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: `Save product ${filename}`,
      content: contentBase64,
      sha: sha || undefined
    })
  });

  if (uploadResp.ok) {
    alert(`Saved to GitHub:\nprod/${filename}`);
  } else {
    const errData = await uploadResp.json();
    alert("GitHub save failed:\n" + JSON.stringify(errData, null, 2));
  }
}


/* ===============================================================
   CLEAR FORM FIELDS
================================================================ */
function clearFormFields() {

  document.getElementById('pcode').value = '';
  document.getElementById('title').value = '';
  document.getElementById('cost').value = '';
  document.getElementById('desc').value = '';
  document.getElementById('descCounter').textContent = '0 / 600';

  document.getElementById('interest').value = '';
  document.getElementById('ptype').value = '';

  if (document.getElementById('prodHtml')) {
    document.getElementById('prodHtml').value = '';
  }

  window.finalProductHTML = '';
}


/* ===============================================================
   BUTTON HANDLERS — CLEAN, SINGLE-TRIGGER SETUP
================================================================ */
document.getElementById("saveBtn").addEventListener("click", () => {
  saveProductFile();
});

document.getElementById("loadBtn").addEventListener("click", () => {
  loadProduct();
});

document.getElementById("saveClearBtn").addEventListener("click", () => {
  saveProductFile();
  if (confirm("Clear all fields?")) clearFormFields();
});

document.getElementById("clearBtn").addEventListener("click", () => {
  if (confirm("Clear all fields?")) clearFormFields();
});

document.getElementById("deleteBtn").addEventListener("click", () => {
  if (confirm("Delete this product file?")) deleteProductFile();
});

document.getElementById("formatBtn").addEventListener("click", () => {
  formatListing();
});
	
</script>

</body>
</html>



