<!-- coding: utf-8 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GPAS Shop Product Formatter</title>

  <!-- 
    NOTE: Your admin menu is a separate file.
    You will include it manually or via JS injection.
    This <link> is NOT used to import HTML, but we keep it here
    as a reminder of where the menu lives.
  -->
  <!-- admin menu lives at: ../gpas-admin/admin-menu.html -->

  <style>
    /* 
      GLOBAL PAGE STYLING 
      --------------------
      Clean, warm, readable. 
      Lexend font at 21px as per your admin design standards.
    */
    body {
      font-family: 'Lexend', sans-serif;
      font-size: 21px;
      margin: 0;
      padding: 0;
      background-color: #fdfdf4; /* soft warm background */
    }

    /* 
      TABLE LAYOUT 
      ------------
      Three columns, each 30% width.
      No scrolling for inputs — only preview scrolls.
    */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    td {
      width: 30%;
      vertical-align: top;
      padding: 10px;
      background-color: #fffbe6; /* soft yellow input zones */
    }

    /* 
      FORM ELEMENTS 
      --------------
      Clean, readable, consistent.
    */
    input, select, textarea {
      width: 95%;
      font-size: 21px;
      margin-bottom: 10px;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    textarea {
      resize: vertical; /* allows expansion for tags */
    }

    /* 
      BUTTONS 
      -------
      Warm, friendly, hover glow.
    */
    button {
      font-size: 21px;
      padding: 8px 16px;
      margin: 8px 0;
      border: none;
      border-radius: 6px;
      background-color: #ffcc66;
      cursor: pointer;
    }

    button:hover {
      background-color: #ffdb99;
    }

    /* 
      PREVIEW BOX 
      -----------
      Only area allowed to scroll.
    */
    #previewBox {
      width: 100%;
      height: 300px;
      overflow: auto;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #fdfdf4;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    /* 
      DESCRIPTION COUNTER 
      --------------------
      Small, subtle, below the textarea.
    */
    #descCounter {
      font-size: 16px;
      color: #666;
      margin-top: -8px;
      margin-bottom: 10px;
    }

    /* 
      CENTER BUTTONS 
      --------------
      For Load / Clear at bottom.
    */
    .center-buttons {
      text-align: center;
      padding: 20px;
    }

    h2, h3 {
      margin-top: 0;
    }

    /* 
      INLINE BUTTON ROW (Save + Delete)
    */
    .inline-buttons {
      display: flex;
      gap: 10px;
    }
  </style>
</head>

<body>

  <!-- 
    ADMIN MENU PLACEHOLDER 
    -----------------------
    You will manually include the admin menu HTML here.
    This keeps your admin UI consistent across all tools.
  -->
  <div id="adminMenu">
    <!-- Insert contents of ../gpas-admin/admin-menu.html here -->
  </div>

  <!-- PAGE TITLE -->
  <h2 style="text-align:center;">GPAS Shop Product Formatter -- 01/06-1</h2>

  <!-- 
    MAIN 3-COLUMN TABLE 
    --------------------
    Column 1: Build the Code + Tags (moved here)
    Column 2: Product Details (now ends after Description)
    Column 3: Format + Preview + Save/Delete (same line)
  -->
  <table>
    <tr>

 <!-- ========================================================= -->
<!-- COLUMN 1 — CONTROL BUTTONS + BUILD THE PRODUCT CODE + TAGS -->
<!-- ========================================================= -->
<td>

  <!-- TOP CONTROL BUTTONS -->
  <div style="margin-bottom:20px;">
    <button id="loadBtn">LOAD PRODUCT</button>
    <button id="clearBtn">CLEAR FORM</button>
  </div>

  <h3>Build Product Code</h3>

  <!-- INTEREST -->
  <label>Interest:</label><br>
  <select id="interest">
    <option value="" selected></option>
    <option value="F">FAITH</option>
    <option value="U">FUN</option>
    <option value="A">ALL</option>
  </select><br>

  <!-- PRODUCT TYPE -->
  <label>Product Type:</label><br>
  <select id="ptype">
    <option value="" selected></option>
    <option value="T">T‑SHIRTS</option>
    <option value="B">BOOKS & BIBLES</option>
    <option value="O">OTHER STUFF</option>
   <option value="E">EVERYTHING</option>
  </select><br>

  <!-- TAGS MOVED HERE -->
  <label>Search Tags (comma separated ", "):</label><br>
  <textarea id="tags" rows="4"></textarea>

</td>

      <!-- ========================================================= -->
      <!-- COLUMN 2 — PRODUCT DETAILS (ends after description)       -->
      <!-- ========================================================= -->
      <td>
        <h3>Product Details</h3>

        <!-- PRODUCT CODE -->
    <div style="display:flex; gap:40px; align-items:flex-start;">

       <div>
            <label for="pcode">Product Code:</label><br>
            <input type="text" id="pcode"
                 style="width:120px; font-weight:bold;"
                 oninput="validateCode(this)">
       </div>

        <!-- PRICE-->
       <div>
            <label for="cost">Price: (No "$" needed)</label><br>
            <input type="text" id="cost"
              style="width:80px; font-weight:bold;"
              oninput="validatePrice(this)">

        </div>

</div>


        <!-- PRODUCT LINK URL -->
        <input id="purl" type="text" placeholder="Product Link URL" style="width:95%;  font-size:21px; font-weight:bold; margin-bottom:10px;">
		
        <!-- SAVE IMAGE AS URL -->
        <input id="imgurl" type="text" placeholder="Save Image As URL" style="width:95%; font-size:21px; font-weight:bold; margin-bottom:10px;">

        <!-- PRODUCT TITLE -->
         <input id="title" type="text" placeholder="Product Title" style="width:95%; font-size:21px; font-weight:bold; margin-bottom:10px;">

         <!-- BOOK AUTHOR or BIBLE VERSION-->
        <input id="author" type="text" placeholder="Author or Version" style="width:95%; font-size:21px; font-weight:bold; margin-bottom:10px;">

        <!-- DESCRIPTION -->
        <label>Description (600 chars):</label><br>
        <textarea id="desc" maxlength="600" rows="5"></textarea>
        <div id="descCounter">0 / 600</div>

        <!-- 
          NOTE:
          Tags were moved to Column 1.
          This frees space so Save/Delete buttons in Column 3
          can align visually with the end of Column 2.
        -->
      </td>

      <!-- ========================================================= -->
      <!-- COLUMN 3 — FORMAT + PREVIEW + SAVE/DELETE (same line)     -->
      <!-- ========================================================= -->
      <td>
        <h3>Format & Preview</h3>

        <!-- FORMAT BUTTON -->
        <button id="formatBtn">FORMAT</button><br>

        <!-- PREVIEW BOX -->
        <div id="previewBox">
          <!-- formatted preview will appear here -->
        </div><br>

        <!-- SAVE + DELETE ON SAME LINE -->
        <div class="inline-buttons">
          <button id="saveBtn">SAVE LISTING</button>
          <button id="deleteBtn">DELETE LISTING</button>
        </div>
      </td>

    </tr>
  </table>

  <!-- ============================================================= -->
  <!-- JAVASCRIPT SECTION                                            -->
  <!-- ============================================================= -->
  <script>

/* --------------------------------------------------------------
   DESCRIPTION CHARACTER COUNTER
-------------------------------------------------------------- */
const desc = document.getElementById('desc');
const descCounter = document.getElementById('descCounter');

desc.addEventListener('input', () => {
  descCounter.textContent = desc.value.length + ' / 600';
});


/* --------------------------------------------------------------
   PRODUCT CODE VALIDATION
   - Always uppercase
   - Only A-Z and 0-9 allowed
   - Dash allowed ONLY after first 3 characters
-------------------------------------------------------------- */
function validateCode(input) {
  let v = input.value.toUpperCase();

  // Allow only A–Z, 0–9, and dash
  v = v.replace(/[^A-Z0-9\-]/g, "");

  // Split on dash, keep only first two parts
  const parts = v.split("-");
  let left = (parts[0] || "").replace(/[^A-Z0-9]/g, "").substring(0, 3);
  let right = (parts[1] || "").replace(/[^0-9]/g, "").substring(0, 3);

  if (!left) {
    input.value = "";
    return;
  }

  // Rebuild as III or III- or III-SSS
  let result = left;
  if (right || v.includes("-")) result += "-";
  if (right) result += right;

  input.value = result;
}


/* --------------------------------------------------------------
   PRICE VALIDATION
-------------------------------------------------------------- */
function validatePrice(input) {
  let v = input.value.replace(/[$,]/g, "");
  v = v.replace(/[^0-9.]/g, "");

  const parts = v.split(".");
  if (parts.length > 2) {
    v = parts[0] + "." + parts[1];
  }

  input.value = v;
}


/* --------------------------------------------------------------
   LIVE PRODUCT CODE BUILDER — IP1-### FORMAT
-------------------------------------------------------------- */
const interest = document.getElementById('interest');
const ptype    = document.getElementById('ptype');
const pcode    = document.getElementById('pcode');

interest.addEventListener('change', buildCodePrefix);
ptype.addEventListener('change', buildCodePrefix);

function buildCodePrefix() {
  const i = interest.value.toUpperCase();
  const t = ptype.value.toUpperCase();

  if (!i || !t) {
    pcode.value = "";
    return;
  }

  const prefix = i + t + "1";
  pcode.value = prefix + "-";
  validateCode(pcode);

  fetchNextSuffix(prefix)
    .then(nextSuffix => {
      pcode.value = prefix + "-" + nextSuffix;
      validateCode(pcode);
    })
    .catch(err => {
      console.error("Error fetching next suffix:", err);
      pcode.value = prefix + "-001";
      validateCode(pcode);
    });
}


/* --------------------------------------------------------------
   FETCH NEXT AVAILABLE SUFFIX FROM GITHUB
-------------------------------------------------------------- */
async function fetchNextSuffix(prefix) {
  const apiUrl = "https://api.github.com/repos/GpaJohnsStories/GpasShop/contents/prod";

  const response = await fetch(apiUrl);
  if (!response.ok) throw new Error("GitHub API error: " + response.status);

  const files = await response.json();
  if (!Array.isArray(files)) throw new Error("Unexpected GitHub response format");

  const regex = new RegExp("^" + prefix + "-?(\\d{3})\\.html$", "i");
  let maxSuffix = 0;

  for (const item of files) {
    if (!item || !item.name) continue;

    const match = item.name.match(regex);
    if (match && match[1]) {
      const num = parseInt(match[1], 10);
      if (!isNaN(num) && num > maxSuffix) maxSuffix = num;
    }
  }

  return String(maxSuffix + 1).padStart(3, "0");
}


/* --------------------------------------------------------------
   ESCAPE HTML ENTITIES
-------------------------------------------------------------- */
function escapeForHTML(str) {
  if (!str) return "";
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}


/* --------------------------------------------------------------
   FORMAT BUTTON → BUILD PREVIEW
-------------------------------------------------------------- */
const formatBtn = document.getElementById('formatBtn');
const previewBox = document.getElementById('previewBox');

formatBtn.addEventListener('click', () => {
  if (validateBeforeFormat()) buildPreview();
});


/* --------------------------------------------------------------
   VALIDATE REQUIRED FIELDS BEFORE FORMATTING
-------------------------------------------------------------- */
function validateBeforeFormat() {
  const code  = document.getElementById('pcode').value.trim();
  const url   = document.getElementById('purl').value.trim();
  const img   = document.getElementById('imgurl').value.trim();
  const title = document.getElementById('title').value.trim();
  const desc  = document.getElementById('desc').value.trim();
  const cost  = document.getElementById('cost').value.trim();

  if (!/^[A-Z0-9]{3}-\d{3}$/.test(code)) {
    alert("Product Code must be III-SSS (example: FB1-001).");
    return false;
  }

  if (url.length < 5) {
    alert("Product Link URL is required.");
    return false;
  }

  if (title.length < 1) {
    alert("Product Title is required.");
    return false;
  }

  if (desc.length < 1) {
    alert("Description is required.");
    return false;
  }

  if (cost && !/^\d+(\.\d{1,2})?$/.test(cost)) {
    alert("Price must be a number like 12.99 (no $ sign).");
    return false;
  }

  return true;
}


/* --------------------------------------------------------------
   BUILD PREVIEW CARD
-------------------------------------------------------------- */
function buildPreview() {
  const code  = escapeForHTML(document.getElementById('pcode').value.trim());
  const url   = escapeForHTML(document.getElementById('purl').value.trim());
  const img   = escapeForHTML(document.getElementById('imgurl').value.trim());
  const title = escapeForHTML(document.getElementById('title').value.trim());
  const cost  = escapeForHTML(document.getElementById('cost').value.trim());
  const desc  = escapeForHTML(document.getElementById('desc').value.trim());
  const tags  = escapeForHTML(document.getElementById('tags').value.trim());

  const cardHTML = `
<div style="width:350px; border:5px solid #c8c8c8; border-radius:14px; box-shadow:4px 4px 8px rgba(0,0,0,0.25); padding:12px; background-color:#fdfdf4;">
  <a href="${url}" target="_blank" style="text-decoration:none; color:black;">
    <img src="${img}" alt="${title}" style="width:100%; height:auto; border:0;">
    <h3 style="margin:10px 0 5px 0; font-size:22px; text-align:center;">${title}</h3>
    <div style="display:flex; justify-content:space-between; align-items:center; margin:0 0 10px 0;">
        <span style="font-size:21px; font-weight:bold;">${code}</span>
        <span style="font-size:21px; font-weight:normal; text-align:right;">$${cost}</span>
    </div>
    <p style="margin:0 0 10px 0; font-size:18px; line-height:1.3;">${desc}</p>
    <p style="margin:0; font-size:14px; color:#666;">Tags: ${tags}</p>
  </a>
</div>`;

  previewBox.innerHTML = cardHTML;
  window.finalProductHTML = cardHTML;
}


/* --------------------------------------------------------------
   SAVE BUTTON HANDLER
-------------------------------------------------------------- */
const saveBtn = document.getElementById('saveBtn');
saveBtn.addEventListener('click', saveProductFile);


/* ================================================================
   GITHUB TOKEN HANDLING (ADMIN SECURITY FLOW)
================================================================ */
function requireToken() {
  let token = sessionStorage.getItem("githubToken");
  if (token) return token;

  alert("A GitHub token is required.\nPlease click the FUN IDEAS button in the admin menu.");
  return null;
}


/* --------------------------------------------------------------
   SAVE PRODUCT FILE DIRECTLY TO GITHUB
-------------------------------------------------------------- */
async function saveProductFile() {

  if (!window.finalProductHTML) {
    alert("Please click FORMAT before saving.");
    return;
  }

  const code = document.getElementById('pcode').value.trim();
  if (!/^[A-Z0-9]{3}-\d{3}$/.test(code)) {
    alert("Product code must look like FB1-001.");
    return;
  }

  const cost = document.getElementById('cost').value.trim();
  const now = new Date().toISOString();

  const timestampComment = "<!-- date_added: " + now + " -->\n\n";
  const priceComment     = "<!-- price: " + cost + " -->\n";

  const fileContent =
    "<!DOCTYPE html>\n<html>\n<head>\n" +
    "  <meta charset='UTF-8'>\n" +
    "  <title>" + code + "</title>\n" +
    "</head>\n<body>\n" +
    timestampComment +
    priceComment +
    window.finalProductHTML +
    "\n</body>\n</html>";

  const token = requireToken();
  if (!token) return;

  const filename = `${code}.html`;
  const filePath = `prod/${filename}`;
  const contentBase64 = btoa(unescape(encodeURIComponent(fileContent)));

  let sha = null;
  const checkUrl = `https://api.github.com/repos/GpaJohnsStories/GpasShop/contents/${filePath}`;

  try {
    const checkResp = await fetch(checkUrl, {
      headers: { "Authorization": `token ${token}` }
    });
    if (checkResp.ok) {
      const data = await checkResp.json();
      sha = data.sha;
    }
  } catch (err) {
    console.error("Error checking file:", err);
  }

  const uploadResp = await fetch(checkUrl, {
    method: "PUT",
    headers: {
      "Authorization": `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: `Save product ${filename}`,
      content: contentBase64,
      sha: sha || undefined
    })
  });

  if (uploadResp.ok) {
    alert(`Saved to GitHub:\nprod/${filename}`);
  } else {
    const errData = await uploadResp.json();
    alert("GitHub save failed:\n" + JSON.stringify(errData, null, 2));
  }
}

</script>

</body>
</html>

