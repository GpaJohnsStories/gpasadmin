<!-- coding: utf-8 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GPAS Shop Product Formatter</title>

  <!-- 
    NOTE: Your admin menu is a separate file.
    You will include it manually or via JS injection.
    This <link> is NOT used to import HTML, but we keep it here
    as a reminder of where the menu lives.
  -->
  <!-- admin menu lives at: ../gpas-admin/admin-menu.html -->

  <style>
    /* 
      GLOBAL PAGE STYLING 
      --------------------
      Clean, warm, readable. 
      Lexend font at 21px as per your admin design standards.
    */
    body {
      font-family: 'Lexend', sans-serif;
      font-size: 21px;
      margin: 0;
      padding: 0;
      background-color: #fdfdf4; /* soft warm background */
    }

    /* 
      TABLE LAYOUT 
      ------------
      Three columns, each 30% width.
      No scrolling for inputs — only preview scrolls.
    */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    td {
      width: 30%;
      vertical-align: top;
      padding: 10px;
      background-color: #fffbe6; /* soft yellow input zones */
    }

    /* 
      FORM ELEMENTS 
      --------------
      Clean, readable, consistent.
    */
    input, select, textarea {
      width: 95%;
      font-size: 21px;
      margin-bottom: 10px;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    textarea {
      resize: vertical; /* allows expansion for tags */
    }

    /* 
      BUTTONS 
      -------
      Warm, friendly, hover glow.
    */
    button {
      font-size: 21px;
      padding: 8px 16px;
      margin: 8px 0;
      border: none;
      border-radius: 6px;
      background-color: #ffcc66;
      cursor: pointer;
    }

    button:hover {
      background-color: #ffdb99;
    }

    /* 
      PREVIEW BOX 
      -----------
      Only area allowed to scroll.
    */
    #previewBox {
      width: 100%;
      height: 300px;
      overflow: auto;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #fff;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    /* 
      DESCRIPTION COUNTER 
      --------------------
      Small, subtle, below the textarea.
    */
    #descCounter {
      font-size: 16px;
      color: #666;
      margin-top: -8px;
      margin-bottom: 10px;
    }

    /* 
      CENTER BUTTONS 
      --------------
      For Load / Clear at bottom.
    */
    .center-buttons {
      text-align: center;
      padding: 20px;
    }

    h2, h3 {
      margin-top: 0;
    }

    /* 
      INLINE BUTTON ROW (Save + Delete)
    */
    .inline-buttons {
      display: flex;
      gap: 10px;
    }
  </style>
</head>

<body>

  <!-- 
    ADMIN MENU PLACEHOLDER 
    -----------------------
    You will manually include the admin menu HTML here.
    This keeps your admin UI consistent across all tools.
  -->
  <div id="adminMenu">
    <!-- Insert contents of ../gpas-admin/admin-menu.html here -->
  </div>

  <!-- PAGE TITLE -->
  <h2 style="text-align:center;">GPAS Shop Product Formatter -- 01/01-1</h2>

  <!-- 
    MAIN 3-COLUMN TABLE 
    --------------------
    Column 1: Build the Code + Tags (moved here)
    Column 2: Product Details (now ends after Description)
    Column 3: Format + Preview + Save/Delete (same line)
  -->
  <table>
    <tr>

 <!-- ========================================================= -->
<!-- COLUMN 1 — CONTROL BUTTONS + BUILD THE PRODUCT CODE + TAGS -->
<!-- ========================================================= -->
<td>

  <!-- TOP CONTROL BUTTONS -->
  <div style="margin-bottom:20px;">
    <button id="loadBtn">LOAD PRODUCT</button>
    <button id="clearBtn">CLEAR FORM</button>
  </div>

  <h3>Build Product Code</h3>

  <!-- INTEREST -->
  <label>Interest:</label><br>
  <select id="interest">
    <option value="" selected></option>
    <option value="F">FAITH</option>
    <option value="U">FUN</option>
    <option value="A">ALL</option>
  </select><br>

  <!-- PRODUCT TYPE -->
  <label>Product Type:</label><br>
  <select id="ptype">
    <option value="" selected></option>
    <option value="B">BOOKS</option>
    <option value="T">T‑SHIRTS</option>
    <option value="O">OTHER STUFF</option>
   <option value="E">EVERYTHING</option
  </select><br>

  <!-- TAGS MOVED HERE -->
  <label>Search Tags (comma separated ", "):</label><br>
  <textarea id="tags" rows="4"></textarea>

</td>

      <!-- ========================================================= -->
      <!-- COLUMN 2 — PRODUCT DETAILS (ends after description)       -->
      <!-- ========================================================= -->
      <td>
        <h3>Product Details</h3>

        <!-- PRODUCT CODE -->
        <label>Product Code (IP1‑???):</label><br>
        <input type="text" id="pcode" style="font-weight:bold;" oninput="validateCode(this)">
        <br>

        <!-- PRODUCT LINK URL -->
        <input id="purl" type="text" placeholder="Product Link URL" style="width:95%;  font-size:21px; font-weight:bold; margin-bottom:10px;">
		
        <!-- SAVE IMAGE AS URL -->
        <input id="imgurl" type="text" placeholder="Save Image As URL" style="width:95%; font-size:21px; font-weight:bold; margin-bottom:10px;">

        <!-- PRODUCT TITLE -->
         <input id="title" type="text" placeholder="Product Title" style="width:95%; font-size:21px; font-weight:bold; margin-bottom:10px;">

         <!-- BOOK AUTHOR or BIBLE VERSION-->
        <input id="author" type="text" placeholder="Author or Version" style="width:95%; font-size:21px; font-weight:bold; margin-bottom:10px;">

        <!-- DESCRIPTION -->
        <label>Description (600 chars):</label><br>
        <textarea id="desc" maxlength="600" rows="5"></textarea>
        <div id="descCounter">0 / 600</div>

        <!-- 
          NOTE:
          Tags were moved to Column 1.
          This frees space so Save/Delete buttons in Column 3
          can align visually with the end of Column 2.
        -->
      </td>

      <!-- ========================================================= -->
      <!-- COLUMN 3 — FORMAT + PREVIEW + SAVE/DELETE (same line)     -->
      <!-- ========================================================= -->
      <td>
        <h3>Format & Preview</h3>

        <!-- FORMAT BUTTON -->
        <button id="formatBtn">FORMAT</button><br>

        <!-- PREVIEW BOX -->
        <div id="previewBox">
          <!-- formatted preview will appear here -->
        </div><br>

        <!-- SAVE + DELETE ON SAME LINE -->
        <div class="inline-buttons">
          <button id="saveBtn">SAVE LISTING</button>
          <button id="deleteBtn">DELETE LISTING</button>
        </div>
      </td>

    </tr>
  </table>

  <!-- ============================================================= -->
  <!-- JAVASCRIPT SECTION                                            -->
  <!-- ============================================================= -->
  <script>

    /* --------------------------------------------------------------
       DESCRIPTION CHARACTER COUNTER
       -------------------------------------------------------------- */
    const desc = document.getElementById('desc');
    const descCounter = document.getElementById('descCounter');

    desc.addEventListener('input', () => {
      descCounter.textContent = desc.value.length + ' / 600';
    });


    /* --------------------------------------------------------------
       PRODUCT CODE VALIDATION
       --------------------------------------------------------------
       Rules:
       - Always uppercase
       - Only A-Z and 0-9 allowed
       - Dash allowed ONLY after first 3 characters
       - No spaces, no symbols
       -------------------------------------------------------------- */
    function validateCode(input) {
      let v = input.value.toUpperCase();

      // Remove all invalid characters
      v = v.replace(/[^A-Z0-9\-]/g, "");

      // No dash allowed before position 4
      if (v.length <= 3) {
        v = v.replace("-", "");
      } else {
        // Force dash at position 4, remove any others
        v = v.substring(0, 3) + "-" + v.substring(4).replace(/-/g, "");
      }

      input.value = v;
    }

  /* --------------------------------------------------------------
     LIVE PRODUCT CODE BUILDER
     --------------------------------------------------------------
     As the user selects:
       - Interest (F/U/A)
       - Type (B/T/O/E)

     The formatter automatically builds the first 3 characters
     of the product code, then adds the dash, then preserves
     any existing 3‑digit suffix the user has typed.

     Example:
       Interest = F (Faith)
       Type = T  (T-Shirt)
        No 3rd position at this time = 1 (Filler)
       → Code becomes: FT1-???
     -------------------------------------------------------------- */

  const interest = document.getElementById('interest');
  const ptype    = document.getElementById('ptype');
  const pcode    = "1";

  // Attach listeners to all three dropdowns
  interest.addEventListener('change', buildCodePrefix);
  ptype.addEventListener('change', buildCodePrefix);

  function buildCodePrefix() {

    // Get the three prefix characters
    const i = interest.value.toUpperCase();  // F, U, A
    const t = ptype.value.toUpperCase();     // B, T, O, e-resize
	const 

    // Build the prefix (first 3 characters)
    const prefix = i + a + t;

    // Preserve any existing suffix AFTER the dash
    let existing = pcode.value.toUpperCase();

    // Strip invalid characters (reuse your validation rules)
    existing = existing.replace(/[^A-Z0-9\-]/g, "");

    // Extract suffix if it exists
    let suffix = "";
    if (existing.length > 4 && existing.includes("-")) {
      suffix = existing.substring(4); // everything after "IAT-"
      suffix = suffix.replace(/[^A-Z0-9]/g, ""); // clean it
    }

    // Rebuild the full code
    let newCode = prefix + "-";
    if (suffix.length > 0) {
      newCode += suffix;
    }

    // Assign back to the input field
    pcode.value = newCode;

    // Run your validation to enforce uppercase + dash rules
    validateCode(pcode);
  }

  const formatBtn = document.getElementById('formatBtn');
  const previewBox = document.getElementById('previewBox');

  /* Converts dangerous characters into safe HTML entities */
  function escapeForHTML(str) {
  if (!str) return "";
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}


  formatBtn.addEventListener('click', buildPreview);

  function buildPreview() {

    // Collect all field values
    const code  = escapeForHTML(document.getElementById('pcode').value.trim());
    const url   = escapeForHTML(document.getElementById('purl').value.trim());
    const img   = escapeForHTML(document.getElementById('imgurl').value.trim());
    const title = escapeForHTML(document.getElementById('title').value.trim());
    const desc  = escapeForHTML(document.getElementById('desc').value.trim());
    const tags  = escapeForHTML(document.getElementById('tags').value.trim());

    // Build the HTML card (inline attributes only)
  const cardHTML = `
<div style="width:350px; 
  border:5px solid #cc6600; 
  border-radius:14px; 
  box-shadow:4px 4px 8px rgba(0,0,0,0.25); 
  padding:12px; background-color:#ffffff;">
  <a href="${url}" target="_blank" style="text-decoration:none; color:black;">
    <img src="${img}" alt="${title}" style="width:100%; height:auto; border:0;">
    <h3 style="margin:10px 0 5px 0; font-size:22px;">${title}</h3>
    <p style="margin:0 0 10px 0; font-size:18px; line-height:1.3;">${desc}</p>
    <p style="margin:0; font-size:14px; color:#666;">Tags: ${tags}</p>
  </a>
</div>`;



    // Show preview in Column 3
    previewBox.innerHTML = cardHTML;

    // Store the HTML so SAVE can write it to file later
    window.finalProductHTML = cardHTML;
  }

/* --------------------------------------------------------------
   SAVE PRODUCT LISTING AS A DOWNLOADABLE HTML FILE
   --------------------------------------------------------------
   - Creates a complete .html file
   - Filename = product code (IP1-???.html)
   - Includes a timestamp comment
   - Contains ONLY the product card HTML
   - Browser downloads the file
-------------------------------------------------------------- */

const saveBtn = document.getElementById('saveBtn');
saveBtn.addEventListener('click', saveProductFile);

function saveProductFile() {

  // Ensure preview was generated
  if (!window.finalProductHTML) {
    alert("Please click FORMAT before saving.");
    return;
  }

  // Get product code for filename
  const code = document.getElementById('pcode').value.trim();
  if (!code || code.length < 5 || !code.includes("-")) {
    alert("Product code is invalid.");
    return;
  }

  const filename = code + ".html";

  // Timestamp
  const now = new Date().toISOString();
  const timestampComment = "<!-- date_added: " + now + " -->\n\n";

  // Build full HTML file content
  const fileContent =
    "<!DOCTYPE html>\n" +
    "<html>\n" +
    "<head>\n" +
    "  <meta charset='UTF-8'>\n" +
    "  <title>" + code + "</title>\n" +
    "</head>\n" +
    "<body>\n" +
    timestampComment +
    window.finalProductHTML +
    "\n</body>\n</html>";

  // Create a downloadable blob
  const blob = new Blob([fileContent], { type: "text/html" });
  const url = URL.createObjectURL(blob);

  // Create a temporary link to trigger download
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();

  // Cleanup
  URL.revokeObjectURL(url);
}  // ← THIS closes saveProductFile correctly


    /* --------------------------------------------------------------
       TODO: ADD YOUR LOGIC HERE
       --------------------------------------------------------------
       - Auto-fill dropdowns when code is typed
       - Auto-generate code when dropdowns change
       - Format preview HTML
       - Load product from /prod/IP1-???.html
       - Save product to /prod/IAT-???.html
       - Delete product with confirmation
       -------------------------------------------------------------- */

  </script>

</body>
</html>
