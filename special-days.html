<!DOCTYPE html>
<html lang="en">
<head>
<!-- Add after <head> tag -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // Initialize Supabase - you'll need your project URL and anon key
    const SUPABASE_URL = 'https://hlywucxwpzbqmzssmwpj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhseXd1Y3h3cHpicW16c3Ntd3BqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg5MTQwNTMsImV4cCI6MjA2NDQ5MDA1M30.m72-z_MYxyijIqclV9hJplTNen02IdLLCOv7w3ZoHfY';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
    
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Special Days</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        /* Filter section */
        .filters {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filters label {
            margin-right: 10px;
            font-weight: bold;
        }
        
        .filters select {
            margin-right: 20px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Table styles */
        table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        th {
            background-color: #4a90e2;
            color: white;
            padding: 12px;
            text-align: left;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background-color: #357abd;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        /* Input and select styles in table */
        td input, td select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        td input[type="date"] {
            width: 130px;
        }
        
        .text-code-input {
            text-transform: uppercase;
            font-family: monospace;
        }
        
        /* Button styles */
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn {
            padding: 5px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.2s;
        }
        
        .btn:hover {
            opacity: 0.8;
        }
        
        .btn-add {
            background-color: #4caf50;
            color: white;
        }
        
        .btn-edit {
            background-color: #ff9800;
            color: white;
        }
        
        .btn-delete {
            background-color: #f44336;
            color: white;
        }
        
        .btn-save {
            background-color: #2196f3;
            color: white;
        }
        
        .btn-cancel {
            background-color: #757575;
            color: white;
        }
        
        /* Story preview section */
          
        .story-details {
            line-height: 1.4;
        }
        
        /* Add new row button */
        .add-new-btn {
            margin-bottom: 20px;
            padding: 10px 20px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .add-new-btn:hover {
            opacity: 0.8;
        }
        
        /* Sort indicators */
        .sort-indicator {
            margin-left: 5px;
            font-size: 12px;
        }
    .past-date {
        background-color: #d0d0d0;
        opacity: 0.8;
    }
		tr.past-date:hover {
    background-color: #d0d0d0 !important;
}
		
		.update-dates-btn {
    margin: 0 0 20px 10px;
    padding: 10px 20px;
    background-color: #f44336;  /* Red background */
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 16px;
}
.story-preview {
    display: block;
    max-width: 300px;
}

.story-details {
    display: inline-block;
    vertical-align: top;
    margin-left: 10px;
}

    td.story-preview {
       max-width: 300px;
       white-space: nowrap;
       overflow: hidden;
       text-overflow: ellipsis;
       }
/* Two-row layout styling */
@import url('https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap');

body {
    font-family: 'Lexend', Arial, sans-serif;
}

table {
    font-size: 19px;
}

/* Remove old story preview styles - delete these if you have them */
.story-preview {
    /* Remove all old story preview styles */
}

/* Style for country cells that span 2 rows */
td[rowspan="2"] {
    vertical-align: top;
    padding-top: 15px !important;
}

/* Blue separator line between special day pairs */
tr.story-row {
    border-bottom: 3px solid #4a90e2;
}

/* Past date styling - lighter gray */
tr.past-date {
    background-color: #e8e8e8;
    opacity: 0.9;
}

tr.past-date:hover {
    background-color: #e8e8e8 !important;
}

/* Bold text styling */
.bold {
    font-weight: 700;
}

/* Right align for "Story:" label */
.story-label {
    text-align: right;
    font-weight: 700;
    font-style: italic;
}
        
    </style>
</head>
<body>
    <h1>Days That Matter</h1>
    
    <button class="add-new-btn" onclick="addNewRow()">Add New Special Day</button>
	<button class="update-dates-btn" onclick="updateAllPastDates()">Update ALL Past Fixed and Calculated Dates</button>
	
    <div class="filters">
        <strong style="margin-right: 20px;">Filter Days that Matter:</strong>
        <label for="siteFilter">Site:</label>
        <select id="siteFilter" onchange="filterTable()">
            <option value="ALL">ALL</option>
            <option value="KIDS">KIDS</option>
            <option value="FAITH">FAITH</option>
            <option value="SHOP">SHOP</option>
        </select>
        
        <label for="countryFilter">Country:</label>
        <select id="countryFilter" onchange="filterTable()">
            <option value="ALL">ALL</option>
            <option value="US">US</option>
            <option value="Australia">Australia</option>
            <option value="Austria">Austria</option>
            <option value="Canada">Canada</option>
            <option value="England">England</option>
            <option value="France">France</option>
            <option value="Germany">Germany</option>
            <option value="Ireland">Ireland</option>
            <option value="Japan">Japan</option>
            <option value="Mexico">Mexico</option>
            <option value="Netherlands">Netherlands</option>
            <option value="Norway">Norway</option>
            <option value="Russia">Russia</option>
            <option value="Scotland">Scotland</option>
            <option value="Spain">Spain</option>
        </select>
    </div>
    
    <table id="specialDaysTable">
 <thead>
    <tr>
        <th onclick="sortTable(0)">Country <span class="sort-indicator">‚Üï</span></th>
        <th onclick="sortTable(1)">Site <span class="sort-indicator">‚Üï</span></th>
        <th onclick="sortTable(2)">Start Date <span class="sort-indicator">‚Üï</span></th>
        <th>End Date</th> <!-- No sort -->
        <th onclick="sortTable(4)">Title <span class="sort-indicator">‚Üï</span></th>
        <th>Photo</th>
        <th onclick="sortTable(6)">Text Code <span class="sort-indicator">‚Üï</span></th>
        <th>Story Info</th>
        <th>Actions</th>
    </tr>
</thead>


        <tbody id="tableBody">
                  </tbody>
    </table>
    
<script>
    // Country list with US at top
    const countries = ['US', 'Australia', 'Austria', 'Canada', 'England', 'France', 'Germany', 'Ireland', 'Japan', 'Mexico', 'Netherlands', 'Norway', 'Russia', 'Scotland', 'Spain'];
    
    // Holiday titles
    const holidays = [
        'Christmas Day', 'Day of the Dead', 'Easter', 'Halloween', 'Hanukkah',
        'Independence Day', 'Labor Day', 'Memorial Day', 'New Year\'s Day',
        'Passover', 'President\'s Day', 'St. Patrick\'s Day', 'Thanksgiving Day',
        'Valentine\'s Day', 'Veteran\'s Day'
    ].sort();
    
    // Sites
    const sites = ['KIDS', 'FAITH', 'SHOP'];
    
    let specialDays = [];
    let editingRow = null;
    
    // Load special days from Supabase on page load
    window.addEventListener('load', loadSpecialDays);
    
    // Load all special days
    async function loadSpecialDays() {
        const { data, error } = await supabase
            .from('special_days')
            .select('*')
            .order('start_date', { ascending: true });
        
        if (error) {
            console.error('Error loading special days:', error);
            return;
        }
        
        specialDays = data || [];
        displaySpecialDays();
    }

// Load story data and populate both rows
async function loadStoryData(row1, row2, textCode) {
    // Get the cells we need to update
    const photoCell = row1.querySelector('.photo-cell');
    const categoryCell = row1.querySelector('.category-cell');
    const storyTitleCell = row2.querySelector('.story-title-cell');
    const pubStatusCell = row2.querySelector('.pub-status-cell');
    
    // Fetch story data from Supabase
    const { data, error } = await supabase
        .from('stories')
        .select('photo_link_1, title, category, publication_status_code')
        .eq('story_code', textCode)
        .single();
    
    if (error || !data) {
        // Story not found - show placeholders
        photoCell.innerHTML = '<img src="placeholder.jpg" width="55" height="55" alt="No photo">';
        categoryCell.textContent = 'Unknown';
        storyTitleCell.textContent = 'Story not found';
        pubStatusCell.innerHTML = 'Pub Status: <strong>?</strong>';
        return;
    }
    
    // Populate the cells with story data
    photoCell.innerHTML = `<img src="${data.photo_link_1 || 'placeholder.jpg'}" width="55" height="55" alt="${textCode}">`;
    categoryCell.textContent = data.category || 'Unknown';
    storyTitleCell.textContent = data.title || 'Untitled';
    pubStatusCell.innerHTML = `Pub Status: <strong>${data.publication_status_code}</strong>`;
}
    
    // Create country dropdown HTML
    function getCountryOptions(selected = 'US') {
        let html = '';
        countries.forEach(country => {
            html += `<option value="${country}" ${country === selected ? 'selected' : ''}>${country}</option>`;
        });
        return html;
    }

// Display special days in table
function displaySpecialDays() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    specialDays.forEach(day => {
        // ... old code ...
    });
}
    
    // Create holiday dropdown HTML
    function getHolidayOptions(selected = '') {
        let html = '<option value="">Select...</option>';
        holidays.forEach(holiday => {
            html += `<option value="${holiday}" ${holiday === selected ? 'selected' : ''}>${holiday}</option>`;
        });
        return html;
    }
    
    // Create site dropdown HTML
    function getSiteOptions(selected = '') {
        let html = '<option value="">Select...</option>';
        sites.forEach(site => {
            html += `<option value="${site}" ${site === selected ? 'selected' : ''}>${site}</option>`;
        });
        return html;
    }
    
    // Format date for input fields
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toISOString().split('T')[0];
    }
   
// Add new row for creating special day - TWO-ROW VERSION
function addNewRow() {
    const tbody = document.getElementById('tableBody');
    
    // Create ROW 1 for new entry
    const newRow1 = document.createElement('tr');
    newRow1.className = 'new-row';
    
    newRow1.innerHTML = `
        <td rowspan="2"><select class="country-select">${getCountryOptions()}</select></td>
        <td rowspan="2"><select class="site-select">${getSiteOptions()}</select></td>
        <td><input type="date" class="start-date" min="${new Date().toISOString().split('T')[0]}"></td>
        <td><input type="date" class="end-date"></td>
        <td><select class="title-select">${getHolidayOptions()}</select></td>
        <td rowspan="2" class="photo-cell">-</td>
        <td><input type="text" class="text-code-input" maxlength="7" placeholder="ABC-123" oninput="this.value = this.value.toUpperCase()"></td>
        <td>Enter code first</td>
        <td rowspan="2" class="action-buttons" style="vertical-align: middle;">
            <button class="btn btn-save" onclick="submitNewRow(this)" title="Save">üíæ</button><br><br>
            <button class="btn btn-cancel" onclick="cancelNewRow(this)" title="Cancel">‚ùå</button>
        </td>
    `;
    
    // Create ROW 2 (mostly empty for new entries)
    const newRow2 = document.createElement('tr');
    newRow2.className = 'new-row story-row';
    
    newRow2.innerHTML = `
        <td colspan="3" style="text-align: center;">Story details will appear after save</td>
        <td></td>
        <td></td>
    `;
    
    // Insert both rows at the top
    tbody.insertBefore(newRow2, tbody.firstChild);
    tbody.insertBefore(newRow1, tbody.firstChild);
    
    // Add date validation
    const startDate = newRow1.querySelector('.start-date');
    const endDate = newRow1.querySelector('.end-date');
    
    startDate.addEventListener('change', function() {
        endDate.min = this.value;
        if (endDate.value && endDate.value < this.value) {
            endDate.value = this.value;
        }
    });
}
  
// Submit new row - TWO-ROW VERSION
async function submitNewRow(btn) {
    // Get the parent row (row1) and the next row (row2)
    const row1 = btn.closest('tr');
    const row2 = row1.nextElementSibling;
    
    const country = row1.querySelector('.country-select').value;
    const startDate = row1.querySelector('.start-date').value;
    const endDate = row1.querySelector('.end-date').value;
    const title = row1.querySelector('.title-select').value;
    const site = row1.querySelector('.site-select').value;
    const textCode = row1.querySelector('.text-code-input').value.toUpperCase();
    
    // Validate all fields
    if (!country || !startDate || !endDate || !title || !site || !textCode) {
        alert('Please fill in all fields');
        return;
    }
    
    // Validate text code format
    if (!/^[A-Z]{3}-[A-Z0-9]{3}$/.test(textCode)) {
        alert('Text code must be in format ABC-123 (3 letters, dash, 3 alphanumeric)');
        return;
    }
    
    // Save to Supabase
    const { data, error } = await supabase
        .from('special_days')
        .insert([{
            country: country === 'USA' ? 'US' : country,
            start_date: startDate,
            end_date: endDate,
            title,
            site,
            text_code: textCode
        }])
        .select()
        .single();
    
    if (error) {
        alert('Error saving: ' + error.message);
        return;
    }
    
    // Add to local array
    specialDays.unshift(data);
    
    // Refresh the entire display with new data
    displaySpecialDays();
}
// Cancel new row - TWO-ROW VERSION
function cancelNewRow(btn) {
    // Get both rows
    const row1 = btn.closest('tr');
    const row2 = row1.nextElementSibling;
    
    // Remove both rows
    row1.remove();
    row2.remove();
}

// Cancel edit - TWO-ROW VERSION
function cancelEdit(id) {
    // Simply refresh the display to restore original state
    displaySpecialDays();
    editingRow = null;
}
    
// Delete row - TWO-ROW VERSION
async function deleteRow(id) {
    if (!confirm('Are you sure you want to delete this special day?')) {
        return;
    }
    
    const { error } = await supabase
        .from('special_days')
        .delete()
        .eq('id', id);
    
    if (error) {
        alert('Error deleting: ' + error.message);
        return;
    }
    
    // Remove from local array
    specialDays = specialDays.filter(d => d.id !== id);
    
    // Refresh display - this removes both rows
    displaySpecialDays();
}

    
    // Filter table by site and country
    function filterTable() {
        const siteFilter = document.getElementById('siteFilter').value;
        const countryFilter = document.getElementById('countryFilter').value;
        
        const tbody = document.getElementById('tableBody');
        const rows = tbody.getElementsByTagName('tr');
        
        for (let row of rows) {
            const site = row.cells[4].textContent;
            const country = row.cells[0].textContent;
            
            const siteMatch = siteFilter === 'ALL' || site === siteFilter;
            const countryMatch = countryFilter === 'ALL' || country === countryFilter;
            
            row.style.display = (siteMatch && countryMatch) ? '' : 'none';
        }
    }
    
    // Sort table
    let sortDirection = {};
    
    function sortTable(column) {
        const tbody = document.getElementById('tableBody');
        const rows = Array.from(tbody.rows);
        
        // Toggle sort direction
        sortDirection[column] = sortDirection[column] === 'asc' ? 'desc' : 'asc';
        
        rows.sort((a, b) => {
            let aValue = a.cells[column].textContent;
            let bValue = b.cells[column].textContent;
            
            // Handle dates
            if (column === 1 || column === 2) {
                aValue = new Date(aValue);
                bValue = new Date(bValue);
            }
            
            if (aValue < bValue) return sortDirection[column] === 'asc' ? -1 : 1;
            if (aValue > bValue) return sortDirection[column] === 'asc' ? 1 : -1;
            return 0;
        });
        
        // Clear and re-add rows
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
    }

async function updateAllPastDates() {
    if (!confirm('This will update fixed and calculated dates. Web-search holidays will stay gray for manual update.')) {
        return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    
    // Define which holidays need calculations
    const needsCalculation = ['Thanksgiving', 'Mother\'s Day', 'Father\'s Day', 'Memorial Day', 'Labor Day'];
    
    // Define which holidays need web search (skip these!)
    const needsWebSearch = ['Easter', 'Passover', 'Hanukkah', 'Ramadan', 'Eid al-Fitr', 'Diwali', 'Chinese New Year'];
    
    const { data: pastDays, error } = await supabase
        .from('special_days')
        .select('*')
        .lt('start_date', today);
    
    if (error) {
        alert('Error: ' + error.message);
        return;
    }
    
    let count = 0;
    let skipped = 0;
    
    for (const day of pastDays) {
        // Skip web-search holidays - leave them gray!
        if (needsWebSearch.includes(day.title)) {
            skipped++;
            continue;
        }
        
        let newStart, newEnd;
        
        if (needsCalculation.includes(day.title)) {
            // Calculate special dates
            const year = new Date(day.start_date).getFullYear() + 1;
            newStart = calculateHoliday(day.title, year);
            newEnd = newStart;
        } else {
            // Fixed dates - just add 1 year
            newStart = new Date(day.start_date);
            newStart.setFullYear(newStart.getFullYear() + 1);
            newStart = newStart.toISOString().split('T')[0];
            
            newEnd = new Date(day.end_date);
            newEnd.setFullYear(newEnd.getFullYear() + 1);
            newEnd = newEnd.toISOString().split('T')[0];
        }
        
        await supabase
            .from('special_days')
            .update({ 
                start_date: newStart,
                end_date: newEnd
            })
            .eq('id', day.id);
            
        count++;
    }
    
    alert(`Updated ${count} dates!\n${skipped} holidays need manual update (still gray).`);
    location.reload();
}

// Add this calculation function
function calculateHoliday(holiday, year) {
    const date = new Date(year, 0, 1); // Start with Jan 1
    
    switch(holiday) {
        case 'Thanksgiving':
            // 4th Thursday of November
            date.setMonth(10); // November (0-based)
            date.setDate(1);   // Start at Nov 1
            // Find first Thursday
            while (date.getDay() !== 4) date.setDate(date.getDate() + 1);
            // Add 3 weeks for 4th Thursday
            date.setDate(date.getDate() + 21);
            break;
            
        case 'Mother\'s Day':
            // 2nd Sunday of May
            date.setMonth(4); // May
            date.setDate(1);
            // Find first Sunday
            while (date.getDay() !== 0) date.setDate(date.getDate() + 1);
            // Add 1 week for 2nd Sunday
            date.setDate(date.getDate() + 7);
            break;
            
        case 'Father\'s Day':
            // 3rd Sunday of June
            date.setMonth(5); // June
            date.setDate(1);
            while (date.getDay() !== 0) date.setDate(date.getDate() + 1);
            date.setDate(date.getDate() + 14); // Add 2 weeks for 3rd
            break;
            
        case 'Memorial Day':
            // Last Monday of May
            date.setMonth(4); // May
            date.setDate(31); // Start at end
            // Work backwards to find last Monday
            while (date.getDay() !== 1) date.setDate(date.getDate() - 1);
            break;
            
        case 'Labor Day':
            // 1st Monday of September
            date.setMonth(8); // September
            date.setDate(1);
            while (date.getDay() !== 1) date.setDate(date.getDate() + 1);
            break;
    }
    
    return date.toISOString().split('T')[0];
}
	
</script>

            
</body>
</html>
